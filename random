package com.cts.employeeasset.userservice.service;

import com.cts.employeeasset.userservice.model.Employee;
import com.cts.employeeasset.userservice.repository.EmployeeRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class EmployeeService {

    private final EmployeeRepository repo;

    // LOGIN
    public Optional<Map<String, Object>> login(String empId, String email, String password) {

        if (empId != null) {
            try {
                Integer id = Integer.parseInt(empId);
                return repo.findById(id)
                        .filter(e -> e.getEmpPassword().equals(password))
                        .map(e -> Map.of(
                                "status", "OK",
                                "empId", e.getEmpId(),
                                "empName", e.getEmpName(),
                                "role", e.getRole()
                        ));
            } catch (Exception ignored) {}
        }

        if (email != null) {
            return repo.findByEmpEmail(email)
                    .filter(e -> e.getEmpPassword().equals(password))
                    .map(e -> Map.of(
                            "status", "OK",
                            "empId", e.getEmpId(),
                            "empName", e.getEmpName(),
                            "role", e.getRole()
                    ));
        }

        return Optional.empty();
    }

    // GET PROFILE
    public Optional<Employee> getEmployee(Integer id) {
        return repo.findById(id);
    }

    // SEARCH EMPLOYEES
    public List<Employee> searchByName(String name) {
        return repo.findByEmpNameContainingIgnoreCase(name);
    }

    // CREATE EMPLOYEE
    public Employee addEmployee(Employee employee) {
        return repo.save(employee);
    }

    // UPDATE EMPLOYEE
    public Optional<Employee> updateEmployee(Integer id, Employee updated) {
        return repo.findById(id).map(existing -> {

            existing.setEmpName(updated.getEmpName());
            existing.setEmpEmail(updated.getEmpEmail());
            existing.setEmpPassword(updated.getEmpPassword());
            existing.setDob(updated.getDob());
            existing.setEmpAddress(updated.getEmpAddress());
            existing.setRole(updated.getRole());

            return repo.save(existing);
        });
    }

    // DELETE EMPLOYEE
    public boolean deleteEmployee(Integer id) {
        if (repo.existsById(id)) {
            repo.deleteById(id);
            return true;
        }
        return false;
    }
}
